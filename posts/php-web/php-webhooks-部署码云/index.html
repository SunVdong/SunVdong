<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>PHP webhook 部署码云 - vdong.xyz</title><meta name=Description content><meta property="og:title" content="PHP webhook 部署码云">
<meta property="og:description" content="版本管理有一个仓库（可以自建，也可以用线上的），将开发者本地的代码每次修改管理起来，可以查看修改记录，回滚等，常用的管理工具有svn 、git"><meta property="og:type" content="article"><meta property="og:url" content="https://www.vdong.xyz/posts/php-web/php-webhooks-%E9%83%A8%E7%BD%B2%E7%A0%81%E4%BA%91/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-04T19:12:06+08:00"><meta property="article:modified_time" content="2023-11-14T06:21:44+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP webhook 部署码云"><meta name=twitter:description content="版本管理有一个仓库（可以自建，也可以用线上的），将开发者本地的代码每次修改管理起来，可以查看修改记录，回滚等，常用的管理工具有svn 、git"><meta name=application-name content="vdong.xyz"><meta name=apple-mobile-web-app-title content="vdong.xyz"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://www.vdong.xyz/posts/php-web/php-webhooks-%E9%83%A8%E7%BD%B2%E7%A0%81%E4%BA%91/><link rel=prev href=https://www.vdong.xyz/posts/php-web/composer/><link rel=next href=https://www.vdong.xyz/posts/git-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"PHP webhook 部署码云","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.vdong.xyz\/posts\/php-web\/php-webhooks-%E9%83%A8%E7%BD%B2%E7%A0%81%E4%BA%91\/"},"genre":"posts","keywords":"php, webhook","wordcount":1517,"url":"https:\/\/www.vdong.xyz\/posts\/php-web\/php-webhooks-%E9%83%A8%E7%BD%B2%E7%A0%81%E4%BA%91\/","datePublished":"2021-11-04T19:12:06+08:00","dateModified":"2023-11-14T06:21:44+00:00","publisher":{"@type":"Organization","name":"vdong"},"author":{"@type":"Person","name":"vdong"},"description":""}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=vdong.xyz>vdong.xyz</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=vdong.xyz>vdong.xyz</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><ul><li><a href=#版本管理>版本管理</a></li><li><a href=#服务器同步>服务器同步</a></li><li><a href=#自动部署>自动部署</a></li><li><a href=#webhook自动部署的原理>webhook自动部署的原理</a></li><li><a href=#具体实现>具体实现</a></li></ul></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">PHP webhook 部署码云</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=/ title=Author rel=author class=author>vdong</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/%E6%8A%80%E6%9C%AF/><i class="far fa-folder fa-fw"></i>技术</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-11-04>2021-11-04</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-11-14>2023-11-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1517 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;<span id=/posts/php-web/php-webhooks-%E9%83%A8%E7%BD%B2%E7%A0%81%E4%BA%91/ class=leancloud_visitors data-flag-title="PHP webhook 部署码云">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class="leancloud-visitors-count waline-pageview-count" data-path=/posts/php-web/php-webhooks-%E9%83%A8%E7%BD%B2%E7%A0%81%E4%BA%91/></span>&nbsp;次阅读
</span>&nbsp;<span id=/posts/php-web/php-webhooks-%E9%83%A8%E7%BD%B2%E7%A0%81%E4%BA%91/ class=comment_count data-flag-title="PHP webhook 部署码云">
<i class="far fa-comments fa-fw"></i>&nbsp;<span class=waline-comment-count id=waline-comment-count data-path=/posts/php-web/php-webhooks-%E9%83%A8%E7%BD%B2%E7%A0%81%E4%BA%91/></span>&nbsp;条评论
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#版本管理>版本管理</a></li><li><a href=#服务器同步>服务器同步</a></li><li><a href=#自动部署>自动部署</a></li><li><a href=#webhook自动部署的原理>webhook自动部署的原理</a></li><li><a href=#具体实现>具体实现</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=版本管理 class=headerLink><a href=#%e7%89%88%e6%9c%ac%e7%ae%a1%e7%90%86 class=header-mark></a>版本管理</h3><p>有一个仓库（可以自建，也可以用线上的），将开发者本地的代码每次修改管理起来，可以查看修改记录，回滚等，常用的管理工具有svn 、git等，主流 git。</p><p>简要流程：</p><ol><li>修改代码</li><li>提交修改到仓库</li></ol><p>当然反过来也可以： 从仓库下载代码到本地  svn： 叫检出（ svn checkout path）； git 叫 拉取（git pull）</p><h3 id=服务器同步 class=headerLink><a href=#%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%90%8c%e6%ad%a5 class=header-mark></a>服务器同步</h3><p>本地修改的代码要上传服务器，才能生效</p><p>简要流程：</p><ol><li>修改代码</li><li>上传服务器（ftp，sftp： 直接本地上传；或者版本仓库里 拉取）</li></ol><h3 id=自动部署 class=headerLink><a href=#%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2 class=header-mark></a>自动部署</h3><p>可以发现第一步是一样的，我们可以把服务器当作一个新的本地环境，我们可以使用计算机，帮我们简化操作流程。</p><p>简化后的流程：</p><ol><li>修改代码</li><li>提交修改到代码仓库</li><li>从仓库拉取代码到服务器，即完成了上传服务器</li></ol><p>以git为例，我们看一些实际部署（手动）：</p><ol><li>本地计算机执行： git commit -am 修改了一些文件</li><li>本地计算机执行： git push origin/master 提交远程版本仓库</li><li>服务器执行： git pull   服务器拉取版本仓库文件</li></ol><p>webhook 帮助我们自动实现这个拉取过程。</p><h3 id=webhook自动部署的原理 class=headerLink><a href=#webhook%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2%e7%9a%84%e5%8e%9f%e7%90%86 class=header-mark></a>webhook自动部署的原理</h3><p><figure><a class=lightgallery href=/imgs/1569555266752-382fa00b-2f12-4b46-b344-7c97742885b5.png title=image.png data-thumbnail=/imgs/1569555266752-382fa00b-2f12-4b46-b344-7c97742885b5.png><img loading=lazy src=/imgs/1569555266752-382fa00b-2f12-4b46-b344-7c97742885b5.png srcset="/imgs/1569555266752-382fa00b-2f12-4b46-b344-7c97742885b5.png, /imgs/1569555266752-382fa00b-2f12-4b46-b344-7c97742885b5.png 1.5x, /imgs/1569555266752-382fa00b-2f12-4b46-b344-7c97742885b5.png 2x" sizes=auto alt=image.png></a></figure></p><p>webhooks：其实就是类似于触发事件</p><p>A事件发生 &mdash;-触发&mdash;-> B事件
push事件  &mdash;-触发&mdash;-> post : <a href=https://www.a.com/pull.php target=_blank rel="noopener noreferrer">www.a.com/pull.php</a> </p><p>pull.php 完成工作： 切到网站根目录，git pull 拉取仓库代码</p><p>核心代码： shell_exec(&ldquo;cd /home/www/www.a.com && git pull 2>&amp;1&rdquo;);</p><h3 id=具体实现 class=headerLink><a href=#%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0 class=header-mark></a>具体实现</h3><h4 id=生成并部署ssh-key class=headerLink><a href=#%e7%94%9f%e6%88%90%e5%b9%b6%e9%83%a8%e7%bd%b2ssh-key class=header-mark></a>生成并部署SSH key</h4><ol><li>服务器上生成ssh key</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ssh-keygen -t rsa -C <span class=s2>&#34;xxxxx@xxxxx.com&#34;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Generating public/private rsa key pair...</span>
</span></span><span class=line><span class=cl><span class=c1># 三次回车即可生成 ssh key</span>
</span></span></code></pre></div><ol start=2><li>查看公钥并添加的码云</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat ~/.ssh/id_rsa.pub
</span></span><span class=line><span class=cl><span class=c1># ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6eNtGpNGwstc....</span>
</span></span></code></pre></div><p>复制以上公钥，添加到仓库 &ldquo;部署公钥管理&rdquo;。<figure><a class=lightgallery href=/imgs/1571716634885-6da18983-92e0-4a7d-b2aa-255889f0e068.png title=image.png data-thumbnail=/imgs/1571716634885-6da18983-92e0-4a7d-b2aa-255889f0e068.png><img loading=lazy src=/imgs/1571716634885-6da18983-92e0-4a7d-b2aa-255889f0e068.png srcset="/imgs/1571716634885-6da18983-92e0-4a7d-b2aa-255889f0e068.png, /imgs/1571716634885-6da18983-92e0-4a7d-b2aa-255889f0e068.png 1.5x, /imgs/1571716634885-6da18983-92e0-4a7d-b2aa-255889f0e068.png 2x" sizes=auto alt=image.png></a></figure></p><ol start=3><li>测试出现如下表示添加成功</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ssh -T git@gitee.com
</span></span><span class=line><span class=cl>Hi Anonymous! You<span class=err>&#39;</span>ve successfully authenticated, but GITEE.COM does not provide shell access.
</span></span><span class=line><span class=cl>Note: Perhaps the current use is DeployKey.
</span></span><span class=line><span class=cl>Note: DeployKey only supports pull/fetch operations
</span></span></code></pre></div><h4 id=服务器初始化clone仓库 class=headerLink><a href=#%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%88%9d%e5%a7%8b%e5%8c%96clone%e4%bb%93%e5%ba%93 class=header-mark></a>服务器初始化clone仓库</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>cd</span> /home/wwwroot/           <span class=c1># 代码存放目录</span>
</span></span><span class=line><span class=cl>$ git clone git@gitee.com:vdong/t.whaoot.com.git
</span></span></code></pre></div><h4 id=准备php代码 class=headerLink><a href=#%e5%87%86%e5%a4%87php%e4%bb%a3%e7%a0%81 class=header-mark></a>准备php代码</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// 本地仓库路径
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$local</span> <span class=o>=</span> <span class=s1>&#39;/home/wwwroot/t.whaoot.com&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 安全验证字符串，为空则不验证
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$token</span> <span class=o>=</span> <span class=s1>&#39;111111&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 如果启用验证，并且验证失败，返回错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$httpToken</span> <span class=o>=</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_X_GITEE_TOKEN&#39;</span><span class=p>])</span> <span class=o>?</span> <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_X_GITEE_TOKEN&#39;</span><span class=p>]</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$token</span> <span class=o>&amp;&amp;</span> <span class=nv>$httpToken</span> <span class=o>!=</span> <span class=nv>$token</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;HTTP/1.1 403 Permission Denied&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;Permission denied.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 如果仓库目录不存在，返回错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$local</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;HTTP/1.1 500 Internal Server Error&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;Local directory is missing&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//如果请求体内容为空，返回错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$payload</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;php://input&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$payload</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;HTTP/1.1 400 Bad Request&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;HTTP HEADER or POST is missing.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * 这里有几点需要注意：
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * 1.确保PHP正常执行系统命令。写一个PHP文件，内容：
</span></span></span><span class=line><span class=cl><span class=cm> * `&lt;?php shell_exec(&#39;ls -la&#39;)`
</span></span></span><span class=line><span class=cl><span class=cm> * 在通过浏览器访问这个文件，能够输出目录结构说明PHP可以运行系统命令。
</span></span></span><span class=line><span class=cl><span class=cm> * 否则 修改web服务器上php.ini的 disable_functions 列表，去掉 shell_exec; 重启php-fpm服务
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * 2、PHP一般使用www-data或者nginx用户运行，PHP通过脚本执行系统命令也是用这个用户，
</span></span></span><span class=line><span class=cl><span class=cm> * 所以必须确保在该用户家目录（一般是/home/www-data或/home/nginx）下有.ssh目录和
</span></span></span><span class=line><span class=cl><span class=cm> * 一些授权文件，以及git配置文件，如下：
</span></span></span><span class=line><span class=cl><span class=cm> * ```
</span></span></span><span class=line><span class=cl><span class=cm> * /root/.ssh
</span></span></span><span class=line><span class=cl><span class=cm> * + .ssh
</span></span></span><span class=line><span class=cl><span class=cm> *   - authorized_keys
</span></span></span><span class=line><span class=cl><span class=cm> *   - config
</span></span></span><span class=line><span class=cl><span class=cm> *   - id_rsa
</span></span></span><span class=line><span class=cl><span class=cm> *   - id_rsa.pub
</span></span></span><span class=line><span class=cl><span class=cm> *   - known_hosts
</span></span></span><span class=line><span class=cl><span class=cm> * - .gitconfig
</span></span></span><span class=line><span class=cl><span class=cm> * ```
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * 3.在执行的命令后面加上2&gt;&amp;1可以输出详细信息，确定错误位置
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * 4.git目录权限问题。比如：
</span></span></span><span class=line><span class=cl><span class=cm> * `fatal: Unable to create &#39;/data/www/html/awaimai/.git/index.lock&#39;: Permission denied`
</span></span></span><span class=line><span class=cl><span class=cm> * 那就是PHP用户没有写权限，需要给目录授予权限:
</span></span></span><span class=line><span class=cl><span class=cm> * ``
</span></span></span><span class=line><span class=cl><span class=cm> * sudo chown -R www:www /data/www/html/awaimai`
</span></span></span><span class=line><span class=cl><span class=cm> * sudo chmod -R g+w /data/www/html/awaimai
</span></span></span><span class=line><span class=cl><span class=cm> * ```
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * 5.SSH认证问题。如果是通过SSH认证，有可能提示错误：
</span></span></span><span class=line><span class=cl><span class=cm> * `Could not create directory &#39;/.ssh&#39;.`
</span></span></span><span class=line><span class=cl><span class=cm> * 或者
</span></span></span><span class=line><span class=cl><span class=cm> * `Host key verification failed.`
</span></span></span><span class=line><span class=cl><span class=cm> *  .ssh 要放到对应的用户目录下
</span></span></span><span class=line><span class=cl><span class=cm> * 例如： php 是以 www 用户运行的， /home/www/.ssh
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#以可写权限打开git_new.log文件，用于记录git日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$fs</span> <span class=o>=</span> <span class=nx>fopen</span><span class=p>(</span><span class=s1>&#39;/home/www/git.t.whaoot.com.log&#39;</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>fwrite</span><span class=p>(</span><span class=nv>$fs</span><span class=p>,</span> <span class=s1>&#39;================ Update Start ===============&#39;</span><span class=o>.</span><span class=nx>PHP_EOL</span><span class=o>.</span><span class=nx>PHP_EOL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>#获取请求端的IP
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$client_ip</span> <span class=o>=</span> <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REMOTE_ADDR&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=c1>#将时间与请求端IP写入日志文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fwrite</span><span class=p>(</span><span class=nv>$fs</span><span class=p>,</span> <span class=s1>&#39;Request on [&#39;</span><span class=o>.</span><span class=nx>date</span><span class=p>(</span><span class=s2>&#34;Y-m-d H:i:s&#34;</span><span class=p>)</span><span class=o>.</span><span class=s1>&#39;] from [&#39;</span><span class=o>.</span><span class=nv>$client_ip</span><span class=o>.</span><span class=s1>&#39;]&#39;</span><span class=o>.</span><span class=nx>PHP_EOL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>#执行shell命令cd到网站根目录执行git pull操作并把返回信息赋值给变量output
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$output</span><span class=o>=</span><span class=nx>shell_exec</span><span class=p>(</span><span class=s2>&#34;cd </span><span class=si>{</span><span class=nv>$local</span><span class=si>}</span><span class=s2> &amp;&amp; git pull 2&gt;&amp;1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>#将日志信息写入日志文件中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fwrite</span><span class=p>(</span><span class=nv>$fs</span><span class=p>,</span> <span class=s1>&#39;Info:&#39;</span><span class=o>.</span> <span class=nv>$output</span><span class=o>.</span><span class=nx>PHP_EOL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>fwrite</span><span class=p>(</span><span class=nv>$fs</span><span class=p>,</span><span class=nx>PHP_EOL</span><span class=o>.</span> <span class=s1>&#39;================ Update End ===============&#39;</span><span class=o>.</span><span class=nx>PHP_EOL</span><span class=o>.</span><span class=nx>PHP_EOL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>#关闭日志文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=nv>$output</span>
</span></span><span class=line><span class=cl><span class=k>die</span><span class=p>(</span><span class=s2>&#34;done &#34;</span> <span class=o>.</span> <span class=nx>date</span><span class=p>(</span><span class=s1>&#39;Y-m-d H:i:s&#39;</span><span class=p>,</span> <span class=nx>time</span><span class=p>()));</span>
</span></span><span class=line><span class=cl><span class=nv>$fs</span> <span class=k>and</span> <span class=nx>fclose</span><span class=p>(</span><span class=nv>$fs</span><span class=p>);</span>
</span></span></code></pre></div><h4 id=绑定webhooks class=headerLink><a href=#%e7%bb%91%e5%ae%9awebhooks class=header-mark></a>绑定webhooks</h4><p>去码云设置 WebHooks，点击测试</p><h4 id=参考链接 class=headerLink><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 class=header-mark></a>参考链接：</h4><p><a href=https://www.awaimai.com/2203.html target=_blank rel="noopener noreferrer">https://www.awaimai.com/2203.html</a></p><p><a href=https://blog.csdn.net/gbenson/article/details/84346696 target=_blank rel="noopener noreferrer">https://blog.csdn.net/gbenson/article/details/84346696</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-11-14</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/php/>php</a>,&nbsp;<a href=/tags/webhook/>webhook</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/php-web/composer/ class=prev rel=prev title=composer><i class="fas fa-angle-left fa-fw"></i>composer</a>
<a href=/posts/git-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/ class=next rel=next title="git 常用命令">git 常用命令<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://waline.js.org/>Waline</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.120.4">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer"></a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/waline/waline.min.css><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{waline:{comment:!0,copyright:!0,dark:"body[theme='dark'], body[theme='black']",el:"#waline",emoji:["https://i.whaoot.com/emojis/qq/"],lang:"zh-cn",pageview:!0,serverURL:"https://comment.vdong.xyz/"}},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/lib/waline/waline.js defer></script><script type=text/javascript src=/js/waline.min.js defer></script></div></body></html>