+++
title = '汇编'
date = 2022-04-22T08:11:06+08:00
draft = true
author = 'vdong'
categories = ['技术']
tags = ['汇编', 'csapp']

+++

## 机器编码

机器级编程的抽象

1. **指令集体 系结构或指令集架构（Instruction Set Architecture, ISA)**来定义机器级程序的格式和行为，它定义了处理器状态、指令的格式，以及每条指令对状态的影响。大多数 ISA 包括 x86-64, 将程序的行为描述成好像每条指令都是按顺序执行的，一条指令结束后，下一条再开始。处理器的硬件远比描述的精细复杂，它们并发地执行许多指令，但是可以采取措施保证整体行为与 ISA 指定的顺序执行的行为完全一致。
2. 机器级程序使用的内存地址是**虚拟地址**，提供的内存模型看上去是一个非常大的字节数组。

对c语言隐藏的处理器细节，对于机器级编程是可见的：

- 程序计数器（pc）：给出将要执行的下一条指令在内存中的地址。（在x86-64 中用 ％rip 表示）
- 整数寄存器文件包含 16 个命名的位置，分别存储 64 位的值。
- 条件码寄存器：算术和逻辑指令的状态信息
- 一组向量寄存器： 一个或多个浮点数

c语言提供各种数据类型的数据，原生数据类型和聚合数据类型，但机器代码只是简单将内存看作很大的、按字节寻址的数组。汇编代码也不区分有无符号，甚至整数和指针。

程序内存包含：

- 程序可执行机器代码
- 操作系统需要的信息
- 管理过程调用和返回的运行时栈
- 已经用户分配的内存块（malloc）

汇编查看

```shell
# 生成汇编代码 mstore.s
gcc -Og -S mstore.c

# 生成目标代码 mstore.o
gcc -Og -c mstore.c

# 反汇编
objdump -d mstore.o

```

字（word） 表示16位数据类型。

movb(传送字节）、 movw(传送字）、 movl(传送双字-long word)和 movq(传送四字）。

16个通用寄存器,不同的寄存器扮演者不同的角色

```txt
- 63                   31           15    7   0
- %rax-----------------%eax---------%ax---%al-- ：返回值 
- %rbx-----------------%ebx---------%bx---%bl-- ：被调用者保存 
- %rcx-----------------%ecx---------%cx---%cl-- ： 第4个参数
- %rdx-----------------%edx---------%dx---%dl-- ：第3个参数
- %rsi-----------------%esi---------%si---%sil-- ：第2个参数 
- %rdi-----------------%edi---------%di---%dil-- ：第1个参数 
- %rbp-----------------%ebp---------%bp---%bpl-- ：被调用者保存
- %rsp-----------------%esp---------%sp---%spl-- ：栈指针 
- %r8------------------%r8d---------%r8w--%r8b-- ：第5个参数
- %r9------------------%r9d---------%r9w--%r9b-- ：第6个参数
- %r10-----------------%r10d--------%r10w--%r10b-- ：调用者保存
- %r11-----------------%r11d--------%r11w--%r11b-- ：调用者保存
- %r12-----------------%r12d--------%r12w--%r12b-- ：被调用者保存
- %r13-----------------%r13d--------%r13w--%r13b-- ：被调用者保存
- %r14-----------------%r14d--------%r14w--%r14b-- ：被调用者保存
- %r15-----------------%r15d--------%r15w--%r15b-- ：被调用者保存
```

操作数

1. 立即数（immediate）：如  `$-577` or `$0x1f` 表示常数值。

2. 寄存器 （register）：表示某个寄存器的内容。r<sub>a</sub> 表示任意寄存器 a  ，R[r<sub>a</sub>] 表示他的值。

3. 内存引用：寻址模式
   $$
   Imm(r_b, r_i, s) = M[Imm+R[r_b]+R[r_i]*s]
   $$

|  类型  |                 格式                 |                  操作数值                  |         名称          |
| :----: | :----------------------------------: | :----------------------------------------: | :-------------------: |
| 立即数 |                 $Imm                 |                    Imm                     |      立即数寻址       |
| 寄存器 |            r<sub>a</sub>             |              R[r<sub>a</sub>]              |      寄存器寻址       |
| 存储器 |                 Imm                  |                   M[Imm]                   |       绝对寻址        |
| 存储器 |           (r<sub>a</sub>)            |            M[R[r<sub>a</sub>]]             |       间接寻址        |
| 存储器 |          Imm(r<sub>b</sub>)          |          M[Imm+R[r<sub>b</sub>]]           | （基址 + 偏移量）寻址 |
| 存储器 |   （r<sub>b</sub>, r<sub>i</sub>）   |   M[R[r<sub>b</sub> ]+R[r<sub>i</sub>]]    |       变址寻址        |
| 存储器 |  Imm(r<sub>b</sub>, r<sub>i</sub>)   | M[Imm+R[r<sub>b</sub> ]+R[r<sub>i</sub>]]  |       变址寻址        |
| 存储器 |       （，r<sub>i</sub>,  s）        |           M[R[r<sub>i</sub>]*s]            |     比例变址寻址      |
| 存储器 |      Imm（，r<sub>i</sub>,  s）      |         M[Imm+R[r<sub>i</sub>]*s ]         |     比例变址寻址      |
| 存储器 | （r<sub>b</sub>, r<sub>i</sub>, s）  |  M[R[r<sub>b</sub>]+R[r<sub>i</sub>]*s ]   |     比例变址寻址      |
| 存储器 | Imm(r<sub>b</sub>, r<sub>i</sub>, s) | M[Imm+R[r<sub>b</sub>]+R[r<sub>i</sub>]*s] |     比例变址寻址      |


数据传送指令

movb(传送字节）

movw(传送字）

movl(传送双字-long word)

movq(传送四字）

movabsq(传送绝对四字)