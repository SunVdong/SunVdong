+++
title = "分布式数据-复制"
date = 2024-04-15T18:00:06+08:00
draft = true
author = 'vdong'
categories = ['生活', '技术']
tags = ['日常', '折腾']
typora-root-url = "..\\..\\..\\static"

+++

复制的原因：

- 使数据和用户在地理位置上更近（降低延迟）
- 使系统即使一部分故障，也能正常工作（提高可用性）
- 伸缩可接受读请求的机器数量（提高读取吞吐量）

复制的困难：在于处理数据的变更。变更复制算法：**单主（singer leader ，单领导者）**，**多主（multi leader，多领导者）**，**无主（leaderless ，无领队者）**。

复制时需要权衡的问题：1. 同步还是异步？2. 如何处理失败的副本？...

## 领导者和追随者

存储了数据库拷贝的每个节点被称为 **副本（replica）**。

每一次向数据库的写入操作都需要传播到所有副本上，否则副本就会包含不一样的数据。解决方案：基于领导者的复制，主从。原理：

1. 其中一个副本被指定为 **领导者（leader）**，也称为 **主库（master|primary）** 。当客户端要向数据库写入时，它必须将请求发送给该 **领导者**，其会将新数据写入其本地存储。
2. 其他副本被称为 **追随者（followers）**，亦称为 **只读副本（read replicas）**、**从库（slaves）**、**备库（ secondaries）** 或 **热备（hot-standby）**。每当领导者将新数据写入本地存储时，它也会将数据变更发送给所有的追随者，称之为 **复制日志（replication log）** 或 **变更流（change stream）**。每个跟随者从领导者拉取日志，并相应更新其本地数据库副本，方法是按照与领导者相同的处理顺序来进行所有写入。
3. 当客户想要从数据库中读取数据时，它可以向领导者或任一追随者进行查询。但只有领导者才能接受写入操作（从客户端的角度来看从库都是只读的）。

这种复制模式是很多关系型数据库的内置功能，也被用于一些非关系数据库（如：MongoDB、RethinkDB 和 Espresso），甚至它不仅限于数据库：Kafka、RabbitMQ 等分布式消息代理也使用它。某些网络文件系统，如 DRBD 这样的块复制设备也类似。

## 同步复制or异步复制

![img](/imgs/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE-%E5%A4%8D%E5%88%B6/fig5-2.png)

